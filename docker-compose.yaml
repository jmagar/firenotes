name: axon

x-common-service: &common-service
  ulimits:
    nofile:
      soft: 65535
      hard: 65535
  restart: unless-stopped
  networks:
    - axon-net
  extra_hosts:
    - "host.docker.internal:host-gateway"
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      compress: "true"
  env_file:
    - .env

services:
  axon-embedder:
    <<: *common-service
    image: node:20-alpine
    container_name: axon-embedder
    working_dir: /app
    volumes:
      - .:/app
      - ${EMBEDDER_QUEUE_DIR:-${AXON_HOME:-${HOME}/.axon}/embed-queue}:/root/.axon/embed-queue
    environment:
      FIRECRAWL_API_URL: ${AXON_EMBEDDER_FIRECRAWL_API_URL:-http://axon-api:${FIRECRAWL_PORT:-53002}}
      QDRANT_URL: ${AXON_EMBEDDER_QDRANT_URL:-http://axon-qdrant:6333}
      AXON_EMBEDDER_QUEUE_DIR: /root/.axon/embed-queue
    command: node dist/embedder-daemon.js
    ports:
      - "${AXON_EMBEDDER_WEBHOOK_PORT:-53000}:53000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:53000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  axon-playwright:
    <<: *common-service
    image: loorisr/patchright-scrape-api:latest
    container_name: axon-playwright
    environment:
      PORT: "${PLAYWRIGHT_PORT:-53006}"
    volumes:
      - ./docker/patchright-app.py:/app/app.py:ro
    tmpfs:
      - /tmp/.cache:noexec,nosuid,size=1g
    healthcheck:
      test: ["CMD", "/app/.venv/bin/python3", "-c", "import socket; s=socket.create_connection(('localhost', ${PLAYWRIGHT_PORT:-53006}), timeout=5); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  axon-api:
    <<: *common-service
    image: ghcr.io/firecrawl/firecrawl:latest
    container_name: firecrawl
    environment:
      PORT: ${FIRECRAWL_PORT:-53002}
      REDIS_URL: ${NUQ_REDIS_URL:-redis://axon-redis:53379}
      DATABASE_URL: ${NUQ_DATABASE_URL}
      RABBITMQ_URL: ${NUQ_RABBITMQ_URL:-amqp://axon-rabbitmq:5672}
      PLAYWRIGHT_MICROSERVICE_URL: ${PLAYWRIGHT_URL:-http://axon-playwright:53006}
    depends_on:
      axon-redis:
        condition: service_healthy
      axon-playwright:
        condition: service_healthy
      axon-rabbitmq:
        condition: service_healthy
      axon-postgres:
        condition: service_healthy
    ports:
      - "${FIRECRAWL_PORT:-53002}:${FIRECRAWL_PORT:-53002}"
    command: node dist/src/index.js
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/${FIRECRAWL_PORT:-53002}' 2>/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  axon-redis:
    <<: *common-service
    image: redis:alpine
    container_name: axon-redis
    command: redis-server --bind 0.0.0.0 --appendonly yes
    volumes:
      - axon_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  axon-rabbitmq:
    <<: *common-service
    image: rabbitmq:3-management
    container_name: axon-rabbitmq
    command: rabbitmq-server
    volumes:
      - axon_rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "check_running"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s

  axon-postgres:
    <<: *common-service
    build: apps/axon-postgres
    container_name: axon-postgres
    volumes:
      - axon_postgres_data:/var/lib/postgresql/data
    command:
      [
        "postgres",
        "-p",
        "${POSTGRES_PORT:-53432}",
        "-c",
        "cron.use_background_workers=on",
        "-c",
        "max_worker_processes=32",
      ]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h 127.0.0.1 -p ${POSTGRES_PORT:-53432} -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-postgres}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  axon-qdrant:
    <<: *common-service
    image: qdrant/qdrant:latest
    container_name: axon-qdrant
    ports:
      - "${QDRANT_REST_PORT:-53333}:6333"
      - "${QDRANT_RPC_PORT:-53334}:6334"
    volumes:
      - ${QDRANT_DATA_DIR:-${AXON_HOME:-${HOME}/.axon}/qdrant}:/qdrant/storage
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/6333' 2>/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  axon-net:
    driver: bridge

volumes:
  axon_redis_data:
  axon_rabbitmq_data:
  axon_postgres_data:
