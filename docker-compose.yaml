name: firecrawl

x-common-service: &common-service
  ulimits:
    nofile:
      soft: 65535
      hard: 65535
  restart: unless-stopped
  networks:
    - jakenet
  extra_hosts:
    - "host.docker.internal:host-gateway"
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      compress: "true"
  env_file:
    - .env

services:
  firecrawl-embedder:
    <<: *common-service
    image: node:20-alpine
    container_name: firecrawl-embedder
    working_dir: /app
    volumes:
      - .:/app
    environment:
      FIRECRAWL_API_URL: http://firecrawl:53002
      QDRANT_URL: http://firecrawl-qdrant:6333
    command: node dist/embedder-daemon.js
    ports:
      - "53000:53000"

  firecrawl-playwright:
    <<: *common-service
    image: loorisr/patchright-scrape-api:latest
    container_name: firecrawl-playwright
    environment:
      PORT: "${PLAYWRIGHT_PORT:-53006}"
    volumes:
      - ./patchright-app.py:/app/app.py:ro
    tmpfs:
      - /tmp/.cache:noexec,nosuid,size=1g

  firecrawl:
    <<: *common-service
    image: ghcr.io/firecrawl/firecrawl:latest
    container_name: firecrawl
    environment:
      PORT: ${FIRECRAWL_PORT:-53002}
    depends_on:
      firecrawl-redis:
        condition: service_started
      firecrawl-playwright:
        condition: service_started
      firecrawl-rabbitmq:
        condition: service_healthy
    ports:
      - "${FIRECRAWL_PORT:-53002}:${FIRECRAWL_PORT:-53002}"
    command: node dist/src/harness.js --start-docker

  firecrawl-redis:
    <<: *common-service
    image: redis:alpine
    container_name: firecrawl-redis
    command: redis-server --bind 0.0.0.0 --port "${REDIS_PORT:-53379}"

  firecrawl-rabbitmq:
    <<: *common-service
    image: rabbitmq:3-management
    container_name: firecrawl-rabbitmq
    command: rabbitmq-server
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "check_running"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s

  nuq-postgres:
    <<: *common-service
    build: apps/nuq-postgres
    container_name: nuq-postgres
    command:
      [
        "postgres",
        "-p",
        "${POSTGRES_PORT:-53432}",
        "-c",
        "cron.use_background_workers=on",
        "-c",
        "max_worker_processes=32",
      ]

  firecrawl-qdrant:
    <<: *common-service
    image: qdrant/qdrant:latest
    container_name: firecrawl-qdrant
    ports:
      - "${QDRANT_REST_PORT:-53333}:6333"
      - "${QDRANT_RPC_PORT:-53334}:6334"
    volumes:
      - ${QDRANT_DATA_DIR:-./data/qdrant}:/qdrant/storage

networks:
  jakenet:
    driver: bridge
