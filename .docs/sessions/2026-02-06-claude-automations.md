# Session: Claude Code Automations Implementation
**Date**: 2026-02-06
**Time**: 15:30:00 | 02/06/2026
**Status**: ✓ Complete

## Objective

Implement Claude Code automations for the CLI Firecrawl project to streamline development workflows:

1. **Testing workflows** - Quick test execution for specific commands during TDD
2. **Infrastructure diagnostics** - Health checks for 7-service Docker stack with embedding model visibility
3. **Code quality automation** - Auto-format/lint after file edits
4. **Deep diagnostics** - Specialized agents for test failure and Docker debugging

## Implementation Summary

### Files Created

**Skills** (User-invocable):
- `.claude/skills/test-command/SKILL.md` - Run tests for specific CLI command
- `.claude/skills/docker-health/SKILL.md` - Check Docker service health + embedding model info

**Agents** (Deep analysis):
- `.claude/agents/cli-tester.md` - Testing specialist for comprehensive test diagnostics
- `.claude/agents/docker-debugger.md` - Docker infrastructure diagnostics specialist

**Configuration Modified**:
- `.claude/settings.local.json` - Added hooks for auto-format, auto-rebuild, and critical file protection

### Architecture Decisions

#### Skills vs Agents
- **Skills**: User-facing entry points for quick operations
  - `/test-command` - Fast feedback loop for test runs
  - `/docker-health` - Quick health overview of services
- **Agents**: Deep analysis specialists spawned by skills
  - `cli-tester` - Detailed test failure analysis, root cause identification
  - `docker-debugger` - Log analysis, network diagnostics, remediation steps

**Key Principle**: Agents do NOT invoke skills. Skills can spawn agents for deep analysis.

#### Hook Design

**PostToolUse Hooks**:
1. **auto-format-biome**: Runs `pnpm biome check --write` on `.ts`, `.json`, `.md` files after Edit/Write
   - Uses `continueOnFailure: true` for warnings without blocking
   - Integrates with existing lint-staged config

2. **auto-rebuild-typescript**: Runs `pnpm build` after non-test `.ts` file changes in `src/`
   - Keeps `dist/` in sync with source
   - Skips test files to avoid rebuilding during test edits

**PreToolUse Hooks**:
1. **block-critical-infrastructure**: Prevents accidental edits to:
   - `docker-compose.yaml` - Controls 7-service stack
   - `pnpm-lock.yaml` - Auto-generated by pnpm
   - `.env` - Contains secrets
   - Requires explicit user permission before editing

### Key Features

#### test-command Skill
- Validates command exists in `src/commands/`
- Runs TypeScript type-check first (fail fast)
- Executes Vitest on command's test files
- Handles commands with subdirectories (e.g., `crawl/`)
- Styled output using project's `theme.ts` utilities
- Can spawn `cli-tester` agent for deep failure analysis

#### docker-health Skill
- **CRITICAL**: Always displays embedding model info banner at top:
  - Model: Qwen/Qwen3-Embedding-0.6B
  - Service: TEI (Text Embeddings Inference)
  - Location: steamy-wsl (100.74.16.82:52000)
  - Hardware: RTX 4070 GPU
  - Vector Dimension: 1024
- Checks all 7 services: firecrawl, embedder, patchright, qdrant, redis, rabbitmq, remote-tei
- Color-coded status: Green ✓ (healthy), Yellow ⚠ (degraded), Red ✗ (unhealthy)
- Displays metadata: queue stats, vector counts, response times
- Provides suggested fixes for failed services
- Can spawn `docker-debugger` agent for deep diagnostics

#### cli-tester Agent
- Executes tests with Vitest (unit, E2E, integration)
- Parses JSON output for structured analysis
- Identifies common failure patterns:
  - Mock reset issues (missing cache resets)
  - Environment leaks (missing `vi.stubEnv()`)
  - Docker dependencies (services not running)
  - Timeouts (async operations, slow services)
- Provides code snippets for fixes
- Reports coverage gaps
- **READ-ONLY**: Never modifies files without approval

#### docker-debugger Agent
- Diagnoses 7-service Docker stack failures
- Analyzes logs (errors, crash loops, request flows)
- Validates configuration (.env, docker-compose.yaml, mounts)
- Network diagnostics (internal connectivity, remote TEI, port conflicts)
- Common failure patterns:
  - Embedder not running (TEI connection issues)
  - Remote TEI unreachable (network/Tailscale issues)
  - Qdrant collections not found (fresh install)
  - RabbitMQ unhealthy (startup delays)
  - Patchright timeout bug (missing patch mount)
  - Port conflicts (services using same port)
- **READ-ONLY by default**: Suggests commands, doesn't execute destructive ops

### Hook Behavior

**Auto-Format (PostToolUse)**:
```bash
# Triggered on Edit/Write for .ts, .json, .md files
pnpm biome check --write <file>
```

**Auto-Rebuild (PostToolUse)**:
```bash
# Triggered on Edit/Write for src/**/*.ts (excluding tests)
pnpm build
```

**Block Critical Files (PreToolUse)**:
```bash
# Blocks Edit/Write on docker-compose.yaml, pnpm-lock.yaml, .env
# Shows error message and exits 1
```

### Integration Points

#### Skills → Agents
- `/test-command` spawns `cli-tester` when tests fail or user requests deep analysis
- `/docker-health` spawns `docker-debugger` when services are unhealthy or user requests diagnostics

#### Hooks → Tools
- PostToolUse hooks run AFTER Edit/Write tools
- PreToolUse hooks run BEFORE Edit/Write tools (can block execution)
- Hooks use shell matchers and case statements for file pattern matching

### Testing Verification

**Test test-command Skill**:
```bash
/test-command scrape    # Valid command
/test-command foobar    # Invalid command (shows available commands)
/test-command crawl     # Command with subdirectory (runs all tests)
```

**Test docker-health Skill**:
```bash
/docker-health                          # All services healthy
docker stop firecrawl-embedder          # Simulate failure
/docker-health                          # Should show embedder unhealthy
```

**Test Auto-Format Hook**:
```bash
# Edit a TypeScript file with incorrect formatting
# Hook should automatically run Biome and format the file
```

**Test Auto-Rebuild Hook**:
```bash
# Edit src/commands/scrape.ts
# Hook should automatically run pnpm build
```

**Test Critical File Protection**:
```bash
# Try to edit docker-compose.yaml
# Hook should block with error message
```

## Technical Details

### Environment
- **Project**: CLI Firecrawl (TypeScript + Node.js)
- **Test Framework**: Vitest v4
- **Code Quality**: Biome (format + lint)
- **Docker Services**: 7 containers (firecrawl, embedder, patchright, qdrant, redis, rabbitmq, remote-tei)
- **Package Manager**: pnpm

### File Locations
- Skills: `.claude/skills/<skill-name>/SKILL.md`
- Agents: `.claude/agents/<agent-name>.md`
- Hooks: `.claude/settings.local.json`

### Hook Schema
- **PostToolUse**: Array of objects with `matcher` and `hooks[]`
- **PreToolUse**: Array of objects with `matcher` and `hooks[]`
- **Hook Types**: `command` (bash), `prompt` (LLM), `agent` (agentic verifier)
- **Matchers**: Regex-like patterns (e.g., `"Edit|Write"`)
- **File Patterns**: Handled via shell case statements in command

## Results

✓ Created 2 skills (test-command, docker-health) with script-first architecture
✓ Created 2 agents (cli-tester, docker-debugger)
✓ Configured 3 hooks (auto-format, auto-rebuild, block-critical)
✓ Implemented progressive disclosure (references/, examples/, scripts/)
✓ Created 2 executable automation scripts (test-command.sh, health-check.sh)
✓ Documented skill development patterns in .claude/skills/CLAUDE.md
✓ All skills reviewed and improved based on plugin-dev best practices
✓ All files validated and structured correctly
✓ Ready for immediate use

## Next Steps

1. ✅ **Test Skills**: Verified `/test-command` and `/docker-health` work with scripts
2. ✅ **Implement Progressive Disclosure**: Added references/ and examples/ directories
3. ✅ **Create Executable Scripts**: Both skills now have automation scripts
4. ✅ **Review and Improve**: Used skill-reviewer agent to improve both skills
5. ✅ **Document Patterns**: Created .claude/skills/CLAUDE.md with project patterns
6. **Test Hooks**: Verify auto-format, auto-rebuild, and critical file blocking in real use
7. **Test Agents**: Spawn agents via skills to verify deep analysis capabilities
8. **Monitor Performance**: Ensure hooks don't slow down development workflow

## Lessons Learned

1. **Hook Schema**: Claude Code uses specific schema for hooks - `PostToolUse`/`PreToolUse` (capital case) with matcher objects
2. **File Pattern Matching**: Hooks use shell case statements for flexibility (avoids complex glob patterns)
3. **continueOnFailure**: Set to `true` for formatting hooks to show warnings without blocking
4. **Agent Design**: Agents use tools directly (Bash, Read, Grep) instead of invoking skills for maximum control
5. **Embedding Model Visibility**: Critical to prominently display embedding model info in docker-health to reinforce that embeddings are enabled

## References

- Plan: Implementation Plan: Claude Code Automations for CLI Firecrawl
- Project Context: CLAUDE.md, README.md
- Theme Utilities: src/utils/theme.ts
- Test Utilities: src/__tests__/utils/test-container.ts
- Docker Compose: docker-compose.yaml
